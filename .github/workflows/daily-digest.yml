name: Daily Digest

on:
  schedule:
    # 16:00 UTC = 8:00 AM PST
    - cron: "0 16 * * *"
  workflow_dispatch: # Allow manual triggers

jobs:
  send-digest:
    runs-on: ubuntu-latest

    env:
      # AI
      AI_PROVIDER: anthropic
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      ANTHROPIC_MODEL: claude-sonnet-4-20250514
      # Email
      RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
      EMAIL_FROM_ADDRESS: onboarding@resend.dev
      EMAIL_FROM_NAME: AI News Digest
      # App
      SECRET_KEY: ${{ secrets.SECRET_KEY }}
      DATABASE_URL: "sqlite+aiosqlite:///./news_digest.db"
      SUMMARY_MAX_LENGTH: "1000"
      MAX_ARTICLES_PER_TOPIC: "10"

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install "pydantic[email]" "bcrypt==4.1.3"
          pip install .

      - name: Send digest
        run: python -m src.run_digest
